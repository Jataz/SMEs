{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}| Dashboard {% endblock title %}

{% block extrastyle %}

  <!-- Ionicons -->
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
  <!-- Tempusdominus Bootstrap 4 -->
  <link rel="stylesheet" href="{% static 'plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css' %}">
  <!-- iCheck -->
  <link rel="stylesheet" href="{% static 'plugins/icheck-bootstrap/icheck-bootstrap.min.css' %}">
  <!-- JQVMap -->
  <link rel="stylesheet" href="{% static 'plugins/jqvmap/jqvmap.min.css' %}">
  <!-- Daterange picker -->
  <link rel="stylesheet" href="{% static 'plugins/daterangepicker/daterangepicker.css' %}">
  <!-- summernote -->
  <link rel="stylesheet" href="{% static 'plugins/summernote/summernote-bs4.min.css' %}">

{% endblock extrastyle %}

{% block bodyclass %} hold-transition sidebar-mini layout-fixed {% endblock bodyclass %}

{% block content %}
  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <div class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1 class="m-0">Dashboard</h1>
          </div><!-- /.col -->
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="#">Home</a></li>
              <li class="breadcrumb-item active">Dashboard</li>
            </ol>
          </div><!-- /.col -->
        </div><!-- /.row -->
      </div><!-- /.container-fluid -->
    </div>
    <!-- /.content-header -->

    <div id="toastContainer" aria-live="polite" aria-atomic="true" style="position: fixed; top: 1rem; right: 1rem; z-index: 1050;"></div>


    <!-- Main content -->
    <section class="content">
      <div class="container-fluid">  
        <!-- Small boxes (Stat box) -->
        <div class="row justify-content-center">
          <div class="col-lg-2 col-6 mb-3">
            <!-- small box -->
            <div class="small-box bg-info">
              <div class="inner">
                <div class="row">
                  <div class="col-6">
                    <h4 class="mb-1 mt-1"><span data-plugin="counterup">{{ total_count }}</span></h4>
                  </div>
                  <div class="col-6 text-right">
                    <h4 class="mb-1 mt-1"><span data-plugin="counterup">{{total_percentage}}%</span></h4>
                  </div>
                </div>
                <div class="text-center">
                  <p class="text-white mb-0">TOTAL</p>
                </div>
              </div>
              <div class="icon">
                <i class="ion ion-pie-gra"></i>
              </div>
              <a href="#" class="small-box-footer"> <i class="fas fa-arrow-circle-right"></i></a>
            </div>
          </div>
        
          <div class="col-lg-2 col-6 mb-3">
            <!-- small box -->
            <div class="small-box bg-warning">
              <div class="inner">
                <div class="row">
                  <div class="col-6">
                    <h4 class="mb-1 mt-1"><span data-plugin="counterup">{{ micro_count }}</span></h4>
                  </div>
                  <div class="col-6 text-right">
                    <h4 class="mb-1 mt-1"><span data-plugin="counterup">{{ micro_percentage }}%</span></h4>
                  </div>
                </div>
                <div class="text-center">
                  <p class="text-white mb-0">MICRO</p>
                </div>
              </div>
              <div class="icon">
                <i class="ion ion-b"></i>
              </div>
              <a href="#" class="small-box-footer"> <i class="fas fa-arrow-circle-right"></i></a>
            </div>
          </div>
          
          <div class="col-lg-2 col-6 mb-3">
            <!-- small box -->
            <div class="small-box bg-secondary">
              <div class="inner">
                <div class="row">
                  <div class="col-6">
                    <h4 class="mb-1 mt-1"><span data-plugin="counterup">{{ small_count }}</span></h4>
                  </div>
                  <div class="col-6 text-right">
                    <h4 class="mb-1 mt-1"><span data-plugin="counterup">{{ small_percentage }}%</span></h4>
                  </div>
                </div>
                <div class="text-center">
                  <p class="text-white mb-0">SMALL</p>
                </div>
              </div>
              <div class="icon">
                <i class="ion ion-stats-ba"></i>
              </div>
              <a href="#" class="small-box-footer"> <i class="fas fa-arrow-circle-right"></i></a>
            </div>
          </div>
          
          <div class="col-lg-2 col-6 mb-3">
            <!-- small box -->
            <div class="small-box bg-success">
              <div class="inner">
                <div class="row">
                  <div class="col-6">
                    <h4 class="mb-1 mt-1"><span data-plugin="counterup">{{ medium_count }}</span></h4>
                  </div>
                  <div class="col-6 text-right">
                    <h4 class="mb-1 mt-1"><span data-plugin="counterup">{{ medium_percentage }}%</span></h4>
                  </div>
                </div>
                <div class="text-center">
                  <p class="text-dark mb-0">MEDIUM</p>
                </div>
              </div>
              <div class="icon">
                <i class="ion ion-tools"></i>
              </div>
              <a href="#" class="small-box-footer"> <i class="fas fa-arrow-circle-right"></i></a>
            </div>
          </div>
          
          <div class="col-lg-2 col-6 mb-3">
            <!-- small box -->
            <div class="small-box bg-danger">
              <div class="inner">
                <div class="row">
                  <div class="col-6">
                    <h4 class="mb-1 mt-1"><span data-plugin="counterup">{{ large_count }}</span></h4>
                  </div>
                  <div class="col-6 text-right">
                    <h4 class="mb-1 mt-1"><span data-plugin="counterup">{{ large_percentage }}%</span></h4>
                  </div>
                </div>
                <div class="text-center">
                  <p class="text-white mb-0">LARGE</p>
                </div>
              </div>
              <div class="icon">
                <i class="ion ion-pie-gra"></i>
              </div>
              <a href="#" class="small-box-footer"> <i class="fas fa-arrow-circle-right"></i></a>
            </div>
          </div>
        </div>
        <!-- /.row -->
        
<!--         <div class="row">
          <div class="col-md-6 my-4">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="fas fa-chart-pie mr-1"></i>
                  Size of Business
                </h3>
                <div class="card-tools">
                  <ul class="nav nav-pills ml-auto">
                    <li class="nav-item">
                      <a class="nav-link active" href="#size-business-bar-chart" data-toggle="tab">Bar</a>
                    </li>
                    <li class="nav-item">
                      <a class="nav-link" href="#size-business-pie-chart" data-toggle="tab">Pie</a>
                    </li>
                  </ul>
                </div>
              </div>
              <div class="card-body">
                <div class="tab-content p-0">
                  <div class="chart tab-pane active" id="size-business-bar-chart" style="position: relative; height: 300px;">
                    <canvas id="size-business-bar-chart-canvas" height="300" style="height: 300px; width: 100%;"></canvas>
                  </div>
                  <div class="chart tab-pane" id="size-business-pie-chart" style="position: relative; height: 300px;">
                    <canvas id="size-business-pie-chart-canvas" height="300" style="height: 300px; width: 100%;"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-6 my-4">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="fas fa-chart-pie mr-1"></i>
                  SEX
                </h3>
                <div class="card-tools">
                  <ul class="nav nav-pills ml-auto">
                    <li class="nav-item">
                      <a class="nav-link active" href="#ownership-bar-chart" data-toggle="tab">Bar</a>
                    </li>
                    <li class="nav-item">
                      <a class="nav-link" href="#ownership-pie-chart" data-toggle="tab">Pie</a>
                    </li>
                  </ul>
                </div>
              </div>
              <div class="card-body">
                <div class="tab-content p-0">
                  <div class="chart tab-pane active" id="ownership-bar-chart" style="position: relative; height: 300px;">
                    <canvas id="ownership-bar-chart-canvas" height="300" style="height: 300px; width: 100%;"></canvas>
                  </div>
                  <div class="chart tab-pane" id="ownership-pie-chart" style="position: relative; height: 300px;">
                    <canvas id="ownership-pie-chart-canvas" height="300" style="height: 300px; width: 100%;"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div> -->

        <div class="row">
          <!-- Demographic Report -->
          <div class="col-md-6 my-4">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="fas fa-chart-pie mr-1"></i> Demographic Report
                </h3>
                <div class="card-tools">
                  <ul class="nav nav-pills ml-auto">
                    <li class="nav-item"><a class="nav-link active" href="#demographic-bar" data-toggle="tab">Bar</a></li>
                    <li class="nav-item"><a class="nav-link" href="#demographic-pie" data-toggle="tab">Pie</a></li>
                  </ul>
                </div>
              </div>
              <div class="card-body">
                <div class="tab-content p-0">
                  <div class="chart tab-pane active" id="demographic-bar">
                    <canvas id="demographicBar"></canvas>
                  </div>
                  <div class="chart tab-pane" id="demographic-pie">
                    <canvas id="demographicPie"></canvas>
                  </div>
                </div>
                <table class="table table-striped mt-4">
                  <tbody id="demographicTableBody" hidden></tbody>
                </table>
                <p id="demographicInsight" class="text-muted mt-3"><strong>Insight:</strong> Loading...</p>
              </div>
            </div>
          </div>
        
          <!-- ownership Report -->
          <div class="col-md-6 my-4">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="fas fa-chart-pie mr-1"></i> ownership Report
                </h3>
                <div class="card-tools">
                  <ul class="nav nav-pills ml-auto">
                    <li class="nav-item"><a class="nav-link active" href="#ownership-bar" data-toggle="tab">Bar</a></li>
                    <li class="nav-item"><a class="nav-link" href="#ownership-pie" data-toggle="tab">Pie</a></li>
                  </ul>
                </div>
              </div>
              <div class="card-body">
                <div class="tab-content p-0">
                  <div class="chart tab-pane active" id="ownership-bar">
                    <canvas id="ownershipBar"></canvas>
                  </div>
                  <div class="chart tab-pane" id="ownership-pie">
                    <canvas id="ownershipPie"></canvas>
                  </div>
                </div>
                <table class="table table-striped mt-4">
                  <tbody id="ownershipTableBody" hidden></tbody>
                </table>
                <p id="ownershipInsight" class="text-muted mt-3"><strong>Insight:</strong> Loading...</p>
              </div>
            </div>
          </div>
      
          <!-- Business Size Report -->
          <div class="col-md-6 my-4">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="fas fa-chart-pie mr-1"></i> Business Size Report
                </h3>
                <div class="card-tools">
                  <ul class="nav nav-pills ml-auto">
                    <li class="nav-item"><a class="nav-link active" href="#business-size-bar" data-toggle="tab">Bar</a></li>
                    <li class="nav-item"><a class="nav-link" href="#business-size-pie" data-toggle="tab">Pie</a></li>
                  </ul>
                </div>
              </div>
              <div class="card-body">
                <div class="tab-content p-0">
                  <div class="chart tab-pane active" id="business-size-bar">
                    <canvas id="businessSizeBar"></canvas>
                  </div>
                  <div class="chart tab-pane" id="business-size-pie">
                    <canvas id="businessSizePie"></canvas>
                  </div>
                </div>
                <table class="table table-striped mt-4">
                  <tbody id="businessSizeTableBody" hidden></tbody>
                </table>
                <p id="businessSizeInsight" class="text-muted mt-3"><strong>Insight:</strong> Loading...</p>
              </div>
            </div>
          </div>
        
          <!-- Financial Performance Report -->
          <div class="col-md-6 my-4">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="fas fa-chart-pie mr-1"></i> Financial Performance Report
                </h3>
                <div class="card-tools">
                  <ul class="nav nav-pills ml-auto">
                    <li class="nav-item"><a class="nav-link active" href="#financial-performance-bar" data-toggle="tab">Bar</a></li>
                    <li class="nav-item"><a class="nav-link" href="#financial-performance-pie" data-toggle="tab">Pie</a></li>
                  </ul>
                </div>
              </div>
              <div class="card-body">
                <div class="tab-content p-0">
                  <div class="chart tab-pane active" id="financial-performance-bar">
                    <canvas id="financialPerformanceBar"></canvas>
                  </div>
                  <div class="chart tab-pane" id="financial-performance-pie">
                    <canvas id="financialPerformancePie"></canvas>
                  </div>
                </div>
                <table class="table table-striped mt-4">
                  <tbody id="financialPerformanceTableBody" hidden></tbody>
                </table>
                <p id="financialPerformanceInsight" class="text-muted mt-3"><strong>Insight:</strong> Loading...</p>
              </div>
            </div>
          </div>
        
          <!-- Export Report -->
          <div class="col-md-6 my-4">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="fas fa-chart-pie mr-1"></i> Export Report
                </h3>
                <div class="card-tools">
                  <ul class="nav nav-pills ml-auto">
                    <li class="nav-item"><a class="nav-link active" href="#export-bar" data-toggle="tab">Bar</a></li>
                    <li class="nav-item"><a class="nav-link" href="#export-pie" data-toggle="tab">Pie</a></li>
                  </ul>
                </div>
              </div>
              <div class="card-body">
                <div class="tab-content p-0">
                  <div class="chart tab-pane active" id="export-bar">
                    <canvas id="exportBar"></canvas>
                  </div>
                  <div class="chart tab-pane" id="export-pie">
                    <canvas id="exportPie"></canvas>
                  </div>
                </div>
                <table class="table table-striped mt-4">
                  <tbody id="exportTableBody" hidden></tbody>
                </table>
                <p id="exportInsight" class="text-muted mt-3"><strong>Insight:</strong> Loading...</p>
              </div>
            </div>
          </div>
        
          <!-- Managerial Education Report -->
          <div class="col-md-6 my-4">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="fas fa-chart-pie mr-1"></i> Managerial Education Report
                </h3>
                <div class="card-tools">
                  <ul class="nav nav-pills ml-auto">
                    <li class="nav-item"><a class="nav-link active" href="#training-education-bar" data-toggle="tab">Bar</a></li>
                    <li class="nav-item"><a class="nav-link" href="#training-education-pie" data-toggle="tab">Pie</a></li>
                  </ul>
                </div>
              </div>
              <div class="card-body">
                <div class="tab-content p-0">
                  <div class="chart tab-pane active" id="training-education-bar">
                    <canvas id="trainingEducationBar"></canvas>
                  </div>
                  <div class="chart tab-pane" id="training-education-pie">
                    <canvas id="trainingEducationPie"></canvas>
                  </div>
                </div>
                <table class="table table-striped mt-4">
                  <tbody id="trainingEducationTableBody" hidden></tbody>
                </table>
                <p id="trainingEducationInsight" class="text-muted mt-3"><strong>Insight:</strong> Loading...</p>
              </div>
            </div>
          </div>
        </div>
        
        <script>
          // Helper function to fetch data and render charts, tables, and insights
          async function fetchReportData(apiUrl, barCanvasId, pieCanvasId, tableBodyId, insightId, label, hasPercentage = true) {
            try {
                const response = await fetch(apiUrl);
                const data = await response.json();

                // Render bar chart
                renderBarChart(barCanvasId, data, label);

                // Render pie chart
                renderPieChart(pieCanvasId, data, label);

                // Render table
                renderTable(tableBodyId, data, hasPercentage);

                // Render insight
                renderInsight(insightId, data);
            } catch (error) {
                console.error('Error fetching or rendering data:', error);
            }
          }

          function renderBarChart(canvasId, data, label) {
            new Chart(document.getElementById(canvasId), {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.data,
                        backgroundColor: [
                            'rgba(0, 255, 0, 0.8)',
                            'rgba(105, 105, 105, 0.5)',
                            'rgba(255, 193, 7, 1)',
                            'rgba(255, 0, 0, 0.5)'
                        ],
                        borderColor: [
                            'rgba(0, 255, 0, 1)',
                            'rgba(105, 105, 105, 1)',
                            'rgba(255, 193, 0, 1)',
                            'rgba(255, 0, 0, 1)'
                        ],
                        borderWidth: 1,
                    }],
                },
                options: {
                    plugins: {
                        legend: {
                            display: false,
                        },
                    },
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true,
                                stepSize: 20,
                                callback: function(value) {
                                    return Number(value).toLocaleString();
                                }
                            },
                            scaleLabel: {
                                display: true,
                            }
                        }],
                        xAxes: [{
                            scaleLabel: {
                                display: true,
                            }
                        }]
                    },
                    legend: {
                        display: false
                    }
                },
            });
          }

          function renderPieChart(canvasId, data, label) {
            new Chart(document.getElementById(canvasId), {
                type: 'pie',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: label,
                        data: data.data,
                        backgroundColor: [
                            'rgba(0, 255, 0, 0.8)',
                            'rgba(105, 105, 105, 0.5)',
                            'rgba(255, 193, 7, 1)',
                            'rgba(255, 0, 0, 0.5)'
                        ],
                        borderColor: [
                            'rgba(0, 255, 0, 1)',
                            'rgba(105, 105, 105, 1)',
                            'rgba(255, 193, 0, 1)',
                            'rgba(255, 0, 0, 1)'
                        ],
                        borderWidth: 1,
                    }],
                },
            });
          }

          function renderTable(tableBodyId, data, hasPercentage) {
            const tableBody = document.getElementById(tableBodyId);
            let total = data.data.reduce((a, b) => a + b, 0);
            let rows = data.labels.map((label, index) => {
                let percentage = hasPercentage ? ((data.data[index] / total) * 100).toFixed(2) : null;
                return `<tr>
                    <td>${label}</td>
                    <td>${data.data[index]}</td>
                    ${hasPercentage ? `<td>${percentage}</td>` : ''}
                </tr>`;
            }).join('');
            tableBody.innerHTML = rows;
          }

          function renderInsight(insightId, data) {
            const insight = document.getElementById(insightId);
            const total = data.data.reduce((a, b) => a + b, 0);
            
            // Check if all values are equal
            const allEqual = data.data.every(val => val === data.data[0]);
            
            if (allEqual) {
              insight.innerHTML = `
              <div style="background-color: #f8f9fa; border-left: 4px solid #3498db; padding: 15px; border-radius: 0 5px 5px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
            <span style="font-weight: bold; color: #2c3e50;">Key Insight:</span> 
            <span style="color: #3498db; font-weight: 500;">All Values are equal</span>
              </div>`;
              return;
            }
    
            const maxIndex = data.data.indexOf(Math.max(...data.data));
            const percentage = ((data.data[maxIndex] / total) * 100).toFixed(1);
            
            insight.innerHTML = `
            <div style="background-color: #f8f9fa; border-left: 4px solid #3498db; padding: 15px; border-radius: 0 5px 5px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
              <span style="font-weight: bold; color: #2c3e50;">Key Insight:</span> 
              <span style="color: #3498db; font-weight: 500;">${data.labels[maxIndex] || 'N/A'}</span> 
              has the highest representation at 
              <span style="color: #e74c3c; font-weight: 500;">${percentage}%</span>
            </div>
            `;
          }f

          // Fetch and render data for all reports
          Promise.all([
            fetchReportData('/api/demographic/', 'demographicBar', 'demographicPie', 'demographicTableBody', 'demographicInsight', 'Number of Businesses'),
            fetchReportData('/api/ownership/', 'ownershipBar', 'ownershipPie', 'ownershipTableBody', 'ownershipInsight', 'ownership Distribution'),
            fetchReportData('/api/age/', 'ageRangeBar', 'ageRangePie', 'ageRangeTableBody', 'ageRangeInsight', 'Age Range Distribution'),
            fetchReportData('/api/business-size/', 'businessSizeBar', 'businessSizePie', 'businessSizeTableBody', 'businessSizeInsight', 'Business Sizes'),
            fetchReportData('/api/financial-performance/', 'financialPerformanceBar', 'financialPerformancePie', 'financialPerformanceTableBody', 'financialPerformanceInsight', 'Average Turnover', false),
            fetchReportData('/api/export/', 'exportBar', 'exportPie', 'exportTableBody', 'exportInsight', 'Export Status'),
            fetchReportData('/api/training-education/', 'trainingEducationBar', 'trainingEducationPie', 'trainingEducationTableBody', 'trainingEducationInsight', 'Training and Education')
          ]).catch(error => {
            console.error('Error in fetching report data:', error);
          });
        </script>
               
      </div><!-- /.container-fluid -->
    </section>
    <!-- /.content -->
  </div>
  {% endblock content %}

  {% block extra_scripts %}
  
    <!-- jQuery UI 1.11.4 -->
    <script src="{% static 'plugins/jquery-ui/jquery-ui.min.js' %}"></script>
    <!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
    <script>
      $.widget.bridge('uibutton', $.ui.button)
    </script>

    <!-- ChartJS -->
    <script src="{% static 'plugins/chart.js/Chart.min.js' %}"></script>
    <!-- Sparkline -->
    <script src="{% static 'plugins/sparklines/sparkline.js' %}"></script>
    <!-- JQVMap -->
    <script src="{% static 'plugins/jqvmap/jquery.vmap.min.js' %}"></script>
    <script src="{% static 'plugins/jqvmap/maps/jquery.vmap.usa.js' %}"></script>
    <!-- jQuery Knob Chart -->
    <script src="{% static 'plugins/jquery-knob/jquery.knob.min.js' %}"></script>
    <!-- daterangepicker -->
    <script src="{% static 'plugins/moment/moment.min.js' %}"></script>
    <script src="{% static 'plugins/daterangepicker/daterangepicker.js' %}"></script>
    <!-- Tempusdominus Bootstrap 4 -->
    <script src="{% static 'plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js' %}"></script>
    <!-- Summernote -->
    <script src="{% static 'plugins/summernote/summernote-bs4.min.js' %}"></script>
    <!-- overlayScrollbars -->
    <script src="{% static 'plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js' %}"></script>
    <!-- AdminLTE dashboard demo (This is only for demo purposes) -->
    <script src="{% static 'dist/js/pages/dashboard.js' %}"></script>
    
  
  {% endblock extra_scripts %}

