{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}| Dashboard {% endblock title %}

{% block extrastyle %}

  <!-- Ionicons -->
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
  <!-- Tempusdominus Bootstrap 4 -->
  <link rel="stylesheet" href="{% static 'plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css' %}">
  <!-- iCheck -->
  <link rel="stylesheet" href="{% static 'plugins/icheck-bootstrap/icheck-bootstrap.min.css' %}">
  <!-- JQVMap -->
  <link rel="stylesheet" href="{% static 'plugins/jqvmap/jqvmap.min.css' %}">
  <!-- Daterange picker -->
  <link rel="stylesheet" href="{% static 'plugins/daterangepicker/daterangepicker.css' %}">
  <!-- summernote -->
  <link rel="stylesheet" href="{% static 'plugins/summernote/summernote-bs4.min.css' %}">

{% endblock extrastyle %}

{% block bodyclass %} hold-transition sidebar-mini layout-fixed {% endblock bodyclass %}

{% block content %}
  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <div class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1 class="m-0">Dashboard</h1>
          </div><!-- /.col -->
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="#">Home</a></li>
              <li class="breadcrumb-item active">Dashboard</li>
            </ol>
          </div><!-- /.col -->
        </div><!-- /.row -->
      </div><!-- /.container-fluid -->
    </div>
    <!-- /.content-header -->

    <div id="toastContainer" aria-live="polite" aria-atomic="true" style="position: fixed; top: 1rem; right: 1rem; z-index: 1050;"></div>


    <!-- Main content -->
    <section class="content">
      <div class="container-fluid">  
        <!-- Small boxes (Stat box) -->
        <div class="row justify-content-center">
          <div class="col-lg-2 col-6 mb-3">
            <!-- small box -->
            <div class="small-box bg-info">
              <div class="inner">
                <div class="row">
                  <div class="col-6">
                    <h4 class="mb-1 mt-1"><span data-plugin="counterup">{{ total_count }}</span></h4>
                  </div>
                  <div class="col-6 text-right">
                    <h4 class="mb-1 mt-1"><span data-plugin="counterup">{{total_percentage}}%</span></h4>
                  </div>
                </div>
                <div class="text-center">
                  <p class="text-white mb-0">TOTAL</p>
                </div>
              </div>
              <div class="icon">
                <i class="ion ion-pie-gra"></i>
              </div>
              <a href="#" class="small-box-footer"> <i class="fas fa-arrow-circle-right"></i></a>
            </div>
          </div>
        
          <div class="col-lg-2 col-6 mb-3">
            <!-- small box -->
            <div class="small-box bg-warning">
              <div class="inner">
                <div class="row">
                  <div class="col-6">
                    <h4 class="mb-1 mt-1"><span data-plugin="counterup">{{ micro_count }}</span></h4>
                  </div>
                  <div class="col-6 text-right">
                    <h4 class="mb-1 mt-1"><span data-plugin="counterup">{{ micro_percentage }}%</span></h4>
                  </div>
                </div>
                <div class="text-center">
                  <p class="text-white mb-0">MICRO</p>
                </div>
              </div>
              <div class="icon">
                <i class="ion ion-b"></i>
              </div>
              <a href="#" class="small-box-footer"> <i class="fas fa-arrow-circle-right"></i></a>
            </div>
          </div>
          
          <div class="col-lg-2 col-6 mb-3">
            <!-- small box -->
            <div class="small-box bg-secondary">
              <div class="inner">
                <div class="row">
                  <div class="col-6">
                    <h4 class="mb-1 mt-1"><span data-plugin="counterup">{{ small_count }}</span></h4>
                  </div>
                  <div class="col-6 text-right">
                    <h4 class="mb-1 mt-1"><span data-plugin="counterup">{{ small_percentage }}%</span></h4>
                  </div>
                </div>
                <div class="text-center">
                  <p class="text-white mb-0">SMALL</p>
                </div>
              </div>
              <div class="icon">
                <i class="ion ion-stats-ba"></i>
              </div>
              <a href="#" class="small-box-footer"> <i class="fas fa-arrow-circle-right"></i></a>
            </div>
          </div>
          
          <div class="col-lg-2 col-6 mb-3">
            <!-- small box -->
            <div class="small-box bg-success">
              <div class="inner">
                <div class="row">
                  <div class="col-6">
                    <h4 class="mb-1 mt-1"><span data-plugin="counterup">{{ medium_count }}</span></h4>
                  </div>
                  <div class="col-6 text-right">
                    <h4 class="mb-1 mt-1"><span data-plugin="counterup">{{ medium_percentage }}%</span></h4>
                  </div>
                </div>
                <div class="text-center">
                  <p class="text-dark mb-0">MEDIUM</p>
                </div>
              </div>
              <div class="icon">
                <i class="ion ion-tools"></i>
              </div>
              <a href="#" class="small-box-footer"> <i class="fas fa-arrow-circle-right"></i></a>
            </div>
          </div>
          
          <div class="col-lg-2 col-6 mb-3">
            <!-- small box -->
            <div class="small-box bg-danger">
              <div class="inner">
                <div class="row">
                  <div class="col-6">
                    <h4 class="mb-1 mt-1"><span data-plugin="counterup">{{ large_count }}</span></h4>
                  </div>
                  <div class="col-6 text-right">
                    <h4 class="mb-1 mt-1"><span data-plugin="counterup">{{ large_percentage }}%</span></h4>
                  </div>
                </div>
                <div class="text-center">
                  <p class="text-white mb-0">LARGE</p>
                </div>
              </div>
              <div class="icon">
                <i class="ion ion-pie-gra"></i>
              </div>
              <a href="#" class="small-box-footer"> <i class="fas fa-arrow-circle-right"></i></a>
            </div>
          </div>
        </div>
        <!-- /.row -->
        
        <div class="row">
          <div class="col-md-6 my-4">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="fas fa-chart-pie mr-1"></i>
                  Size of Business
                </h3>
                <div class="card-tools">
                  <ul class="nav nav-pills ml-auto">
                    <li class="nav-item">
                      <a class="nav-link active" href="#size-business-bar-chart" data-toggle="tab">Bar</a>
                    </li>
                    <li class="nav-item">
                      <a class="nav-link" href="#size-business-pie-chart" data-toggle="tab">Pie</a>
                    </li>
                  </ul>
                </div>
              </div>
              <div class="card-body">
                <div class="tab-content p-0">
                  <div class="chart tab-pane active" id="size-business-bar-chart" style="position: relative; height: 300px;">
                    <canvas id="size-business-bar-chart-canvas" height="300" style="height: 300px; width: 100%;"></canvas>
                  </div>
                  <div class="chart tab-pane" id="size-business-pie-chart" style="position: relative; height: 300px;">
                    <canvas id="size-business-pie-chart-canvas" height="300" style="height: 300px; width: 100%;"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-6 my-4">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="fas fa-chart-pie mr-1"></i>
                  SEX
                </h3>
                <div class="card-tools">
                  <ul class="nav nav-pills ml-auto">
                    <li class="nav-item">
                      <a class="nav-link active" href="#gender-bar-chart" data-toggle="tab">Bar</a>
                    </li>
                    <li class="nav-item">
                      <a class="nav-link" href="#gender-pie-chart" data-toggle="tab">Pie</a>
                    </li>
                  </ul>
                </div>
              </div>
              <div class="card-body">
                <div class="tab-content p-0">
                  <div class="chart tab-pane active" id="gender-bar-chart" style="position: relative; height: 300px;">
                    <canvas id="gender-bar-chart-canvas" height="300" style="height: 300px; width: 100%;"></canvas>
                  </div>
                  <div class="chart tab-pane" id="gender-pie-chart" style="position: relative; height: 300px;">
                    <canvas id="gender-pie-chart-canvas" height="300" style="height: 300px; width: 100%;"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 my-4">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">
                  <i class=" mr-1"></i>
                  Age Range Distribution
                  
                </h3>
                <div class="card-tools">
                  <ul class="nav nav-pills ml-auto">
                  </ul>
                </div>
              </div>
              <div class="card-body">
                <div id="age-range-container">
                  <p>Loading age range data...</p>
              </div>
              </div>
            </div>
          </div>
        </div>
        
        <script>
          document.addEventListener("DOMContentLoaded", function() {
            // Fetch data and render bar chart
            function fetchDataAndRenderSizeBarChart() {
              fetch("{% url 'size_of_business_data' %}")
                .then(response => response.json())
                .then(data => {
                  if (data.labels.length === 0) {
                    document.getElementById('size-business-bar-chart-canvas').innerHTML = 'No data available';
                  } else {
                    var ctx = document.getElementById('size-business-bar-chart-canvas').getContext('2d');
                    var barChart = new Chart(ctx, {
                      type: 'bar',
                      data: {
                        labels: data.labels,
                        datasets: [{
                          label: '', // Set label to an empty string
                          data: data.data,
                          backgroundColor: [
                            'rgba(0, 255, 0, 0.8)',
                            'rgba(105, 105, 105, 0.5)',
                            'rgba(255, 193, 7, 1)',
                            'rgba(255, 0, 0, 0.5)'
                          ],
                          borderColor: [
                            'rgba(0, 255, 0, 1)',
                            'rgba(105, 105, 105, 1)',
                            'rgba(255, 193, 0, 1)',
                            'rgba(255, 0, 0, 1)'
                          ],
                          borderWidth: 1,
                        }]
                      },
                      options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                          yAxes: [{
                            ticks: {
                              beginAtZero: true,
                              stepSize: 20,
                              callback: function(value) {
                                return Number(value).toLocaleString();
                              }
                            },
                            scaleLabel: {
                              display: true,
                              labelString: 'Number of SMEs in %'
                            }
                          }],
                          xAxes: [{
                            scaleLabel: {
                              display: true,
                              labelString: 'Size of Business'
                            }
                          }]
                        },
                        // Hide legend
                        legend: {
                          display: false
                        }
                      }
                    });
                  }
                })
                .catch(error => {
                  console.error('Error fetching data:', error);
                  document.getElementById('size-business-bar-chart-canvas').innerHTML = 'Error fetching data';
                });
            }
        
            // Fetch data and render pie chart
            function fetchDataAndRenderSizePieChart() {
              fetch("{% url 'size_of_business_data' %}")
                .then(response => response.json())
                .then(data => {
                  if (data.labels.length === 0) {
                    var noDataText = document.createTextNode("No data available");
                    var chartContainer = document.getElementById('size-business-pie-chart-canvas');
                    chartContainer.innerHTML = ''; // Clear any existing content
                    chartContainer.appendChild(noDataText);
                  } else {
                    var ctx = document.getElementById('size-business-pie-chart-canvas').getContext('2d');
                    var pieChart = new Chart(ctx, {
                      type: 'pie',
                      data: {
                        labels: data.labels,
                        datasets: [{
                          data: data.data,
                          backgroundColor: [
                            'rgba(0, 255, 0, 0.8)',
                            'rgba(105, 105, 105, 0.5)',
                            'rgba(255, 193, 7, 1)',
                            'rgba(255, 0, 0, 0.5)'
                          ],
                          borderColor: [
                            'rgba(0, 255, 0, 1)',
                            'rgba(105, 105, 105, 1)',
                            'rgba(255, 193, 0, 1)',
                            'rgba(255, 0, 0, 1)'
                          ],
                          borderWidth: 1
                        }]
                      },
                      options: {
                        responsive: true,
                        maintainAspectRatio: false
                      }
                    });
                  }
                })
                .catch(error => {
                  console.error('Error fetching data:', error);
                  document.getElementById('size-business-pie-chart-canvas').innerHTML = 'Error fetching data';
                });
            }
        
            fetchDataAndRenderSizeBarChart();
            fetchDataAndRenderSizePieChart();
        
            // Ensure charts are re-rendered when switching tabs
            $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
              var target = $(e.target).attr("href"); // activated tab
              if (target === '#size-business-bar-chart') {
                fetchDataAndRenderSizeBarChart();
              } else if (target === '#size-business-pie-chart') {
                fetchDataAndRenderSizePieChart();
              }
            });
          });

          document.addEventListener("DOMContentLoaded", function() {
            // Fetch data and render bar chart
            function fetchDataAndRenderGenderBarChart() {
              fetch("{% url 'sex_data' %}")
                .then(response => response.json())
                .then(data => {
                  if (data.labels.length === 0) {
                    document.getElementById('gender-bar-chart-canvas').innerHTML = 'No data available';
                  } else {
                    var ctx = document.getElementById('gender-bar-chart-canvas').getContext('2d');
                    var barChart = new Chart(ctx, {
                      type: 'bar',
                      data: {
                        labels: data.labels,
                        datasets: [{
                          label: '', // Set label to an empty string
                          data: data.data,
                          backgroundColor: [
                            'rgba(0, 255, 0, 0.8)',
                            'rgba(105, 105, 105, 0.5)',
                            'rgba(255, 193, 7, 1)',
                            'rgba(255, 0, 0, 0.5)'
                          ],
                          borderColor: [
                            'rgba(0, 255, 0, 1)',
                            'rgba(105, 105, 105, 1)',
                            'rgba(255, 193, 0, 1)',
                            'rgba(255, 0, 0, 1)'
                          ],
                          borderWidth: 1,
                        }]
                      },
                      options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                          yAxes: [{
                            ticks: {
                              beginAtZero: true,
                              stepSize: 20,
                              callback: function(value) {
                                return Number(value).toLocaleString();
                              }
                            },
                            scaleLabel: {
                              display: true,
                              labelString: 'Total Number in %'
                            }
                          }],
                          xAxes: [{
                            scaleLabel: {
                              display: true,
                              labelString: 'Sex'
                            }
                          }]
                        },
                        // Hide legend
                        legend: {
                          display: false
                        }
                      }
                    });
                  }
                })
                .catch(error => {
                  console.error('Error fetching data:', error);
                  document.getElementById('gender-bar-chart-canvas').innerHTML = 'Error fetching data';
                });
            }
        
            // Fetch data and render pie chart
            function fetchDataAndRenderGenderPieChart() {
              fetch("{% url 'sex_data' %}")
                .then(response => response.json())
                .then(data => {
                  if (data.labels.length === 0) {
                    var noDataText = document.createTextNode("No data available");
                    var chartContainer = document.getElementById('gender-pie-chart-canvas');
                    chartContainer.innerHTML = ''; // Clear any existing content
                    chartContainer.appendChild(noDataText);
                  } else {
                    var ctx = document.getElementById('gender-pie-chart-canvas').getContext('2d');
                    var pieChart = new Chart(ctx, {
                      type: 'pie',
                      data: {
                        labels: data.labels,
                        datasets: [{
                          data: data.data,
                          backgroundColor: [
                            'rgba(0, 255, 0, 0.8)',
                            'rgba(105, 105, 105, 0.5)',
                            'rgba(255, 193, 7, 1)',
                            'rgba(255, 0, 0, 0.5)'
                          ],
                          borderColor: [
                            'rgba(0, 255, 0, 1)',
                            'rgba(105, 105, 105, 1)',
                            'rgba(255, 193, 0, 1)',
                            'rgba(255, 0, 0, 1)'
                          ],
                          borderWidth: 1
                        }]
                      },
                      options: {
                        responsive: true,
                        maintainAspectRatio: false
                      }
                    });
                  }
                })
                .catch(error => {
                  console.error('Error fetching data:', error);
                  document.getElementById('gender-pie-chart-canvas').innerHTML = 'Error fetching data';
                });
            }
        
            fetchDataAndRenderGenderBarChart();
            fetchDataAndRenderGenderPieChart();
        
            // Ensure charts are re-rendered when switching tabs
            $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
              var target = $(e.target).attr("href"); // activated tab
              if (target === '#gender-bar-chart') {
                fetchDataAndRenderGenderBarChart();
              } else if (target === '#gender-pie-chart') {
                fetchDataAndRenderGenderPieChart();
              }
            });
          });
        </script>

        <script>
          function fetchAgeRangeData(province_id = null, district_id = null, ward_id = null) {
              let url = '/api/v1/age-range-report/';
              let params = [];
      
              if (province_id) params.push(`province_id=${province_id}`);
              if (district_id) params.push(`district_id=${district_id}`);
              if (ward_id) params.push(`ward_id=${ward_id}`);
              if (params.length > 0) url += '?' + params.join('&');
      
              fetch(url)
                  .then(response => response.json())
                  .then(data => {
                      const container = document.getElementById('age-range-container');
                      container.innerHTML = `
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Age Range</th>
                                            <th>Number of SMEs</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>18-25</td>
                                            <td>${data.age_range_report["18-25"]}</td>
                                        </tr>
                                        <tr>
                                            <td>26-35</td>
                                            <td>${data.age_range_report["26-35"]}</td>
                                        </tr>
                                        <tr>
                                            <td>36-45</td>
                                            <td>${data.age_range_report["36-45"]}</td>
                                        </tr>
                                        <tr>
                                            <td>46-55</td>
                                            <td>${data.age_range_report["46-55"]}</td>
                                        </tr>
                                        <tr>
                                            <td>56+</td>
                                            <td>${data.age_range_report["56+"]}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                      `;
                  })
                  .catch(error => {
                      console.error('Error fetching age range data:', error);
                      document.getElementById('age-range-container').innerHTML = '<p>Error loading data.</p>';
                  });
          }
      
          // Fetch the data when the page loads
          document.addEventListener('DOMContentLoaded', function () {
              fetchAgeRangeData();
          });
      </script>
        
      </div><!-- /.container-fluid -->
    </section>
    <!-- /.content -->
  </div>
  {% endblock content %}

  {% block extra_scripts %}
  
    <!-- jQuery UI 1.11.4 -->
    <script src="{% static 'plugins/jquery-ui/jquery-ui.min.js' %}"></script>
    <!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
    <script>
      $.widget.bridge('uibutton', $.ui.button)
    </script>

    <!-- ChartJS -->
    <script src="{% static 'plugins/chart.js/Chart.min.js' %}"></script>
    <!-- Sparkline -->
    <script src="{% static 'plugins/sparklines/sparkline.js' %}"></script>
    <!-- JQVMap -->
    <script src="{% static 'plugins/jqvmap/jquery.vmap.min.js' %}"></script>
    <script src="{% static 'plugins/jqvmap/maps/jquery.vmap.usa.js' %}"></script>
    <!-- jQuery Knob Chart -->
    <script src="{% static 'plugins/jquery-knob/jquery.knob.min.js' %}"></script>
    <!-- daterangepicker -->
    <script src="{% static 'plugins/moment/moment.min.js' %}"></script>
    <script src="{% static 'plugins/daterangepicker/daterangepicker.js' %}"></script>
    <!-- Tempusdominus Bootstrap 4 -->
    <script src="{% static 'plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js' %}"></script>
    <!-- Summernote -->
    <script src="{% static 'plugins/summernote/summernote-bs4.min.js' %}"></script>
    <!-- overlayScrollbars -->
    <script src="{% static 'plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js' %}"></script>
    <!-- AdminLTE dashboard demo (This is only for demo purposes) -->
    <script src="{% static 'dist/js/pages/dashboard.js' %}"></script>
    
  
  {% endblock extra_scripts %}

